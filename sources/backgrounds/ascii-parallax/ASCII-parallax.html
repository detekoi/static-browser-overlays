<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Psychedelic ASCII — Parallax Restored</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#000;
      --weight:700;
      --ls:0.02em;
      --lh:0.78;
    }
    html, body{
      height:100%;
      margin:0;
      background:var(--bg);
      overflow:hidden;
    }
    .wrap{
      position:fixed;
      inset:0;
      pointer-events:none;
    }
    .container {
      position: absolute;
      inset: -12vh -12vw;
      display: grid;
      place-items: center;
      will-change: transform;
      animation: parallax-a 140s linear infinite, hue-a 120s linear infinite;
      overflow: hidden;
    }
    #container2 {
      animation: parallax-b 170s linear infinite, hue-b 140s linear infinite;
    }
    pre{
      margin:0;
      white-space:pre;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-weight:var(--weight);
      letter-spacing:var(--ls);
      line-height:var(--lh);
      background-image:
        linear-gradient(135deg,
          #2c2c2c, #4b3b47, #7a5c61, #a8896c, #d1c7b7, #a88fa0, #6b5c6e, #2c2c2c),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.018) 0 2px, rgba(0,0,0,0.018) 2px 4px),
        repeating-linear-gradient(90deg, rgba(0,0,0,0.012) 0 3px, rgba(255,255,255,0.012) 3px 6px);
      background-size: 260% 260%, 100% 100%, 100% 100%;
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
      user-select:none;
      animation: none;
    }
    #bg2 {
      opacity: 0.55;
      background-image:
        linear-gradient(315deg,
          #242424, #3e3340, #6d555b, #9c7d67, #cdbfb0, #9f8597, #5b4e60, #242424),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.016) 0 2px, rgba(0,0,0,0.016) 2px 4px),
        repeating-linear-gradient(90deg, rgba(0,0,0,0.010) 0 3px, rgba(255,255,255,0.010) 3px 6px);
      background-size: 320% 320%, 100% 100%, 100% 100%;
      background-blend-mode: overlay, soft-light, normal;
    }
    @keyframes drift-x { from { background-position-x: 0%; } to { background-position-x: 200%; } }
    @keyframes drift-y { from { background-position-y: 0%; } to { background-position-y: 200%; } }
    @keyframes parallax-a {
      0%   { transform: translate(-4%, -3%); }
      25%  { transform: translate( 4%, -3%); }
      50%  { transform: translate( 4%,  3%); }
      75%  { transform: translate(-4%,  3%); }
      100% { transform: translate(-4%, -3%); }
    }
    @keyframes parallax-b {
      0%   { transform: translate( 4%,  3%); }
      25%  { transform: translate(-4%,  3%); }
      50%  { transform: translate(-4%, -3%); }
      75%  { transform: translate( 4%, -3%); }
      100% { transform: translate( 4%,  3%); }
    }
    @keyframes hue-a { from { filter: hue-rotate(0deg); } to { filter: hue-rotate(360deg); } }
    @keyframes hue-b { from { filter: hue-rotate(360deg); } to { filter: hue-rotate(0deg); } }
    @media (prefers-reduced-motion: reduce){ .container, pre { animation:none !important; } }
  </style>
</head>
<body>
  <div class="wrap">
      <div class="container" id="container1">
        <pre id="bg1" aria-hidden="true"></pre>
      </div>
      <div class="container" id="container2">
        <pre id="bg2" aria-hidden="true"></pre>
      </div>
  </div>
  <script>
  (() => {
    const q = new URLSearchParams(location.search);
    const FONT_SIZE  = +(q.get('fs')      || 20);
    const DENSITY    = +(q.get('density') || 0.7);
    const LAYERS = +(q.get('layers') || 2);
    const RAMP = "@#%WM&8B$0X*+=-:.  ";
    const RAMP_LEN = RAMP.length - 1;
    const el1 = document.getElementById('bg1');
    const el2 = document.getElementById('bg2');

    el1.style.fontSize = FONT_SIZE + 'px';
    el2.style.fontSize = FONT_SIZE + 'px';

    function measure() {
      const s = document.createElement('span');
      s.textContent = 'M';
      const cs = getComputedStyle(el1);
      s.style.font = cs.font;
      s.style.lineHeight = cs.lineHeight;
      s.style.letterSpacing = cs.letterSpacing;
      s.style.position = 'absolute';
      s.style.visibility = 'hidden';
      document.body.appendChild(s);
      const r = s.getBoundingClientRect();
      s.remove();
      return {
        cw: Math.max(1, r.width  || FONT_SIZE * 0.6),
        ch: Math.max(1, r.height || FONT_SIZE * 0.9),
      };
    }

    function generateArt(cols, rows, seed) {
        const cx = cols * 0.5;
        const cy = rows * 0.5;
        const lines = new Array(rows);
        for (let y = 0; y < rows; y++) {
            const row = new Array(cols);
            const ny = (y - cy) / rows;
            for (let x = 0; x < cols; x++) {
                const nx = (x - cx) / cols;
                const r = Math.hypot(nx, ny);
                const a = Math.atan2(ny, nx);
                const raw_v = Math.sin(r * DENSITY * 8 + a * 4 + seed) + Math.sin(a * 8);
                const v = raw_v / 2.0;
                const ch = RAMP[ ((v + 1) * 0.5 * RAMP_LEN) | 0 ];
                row[x] = ch;
            }
            lines[y] = row.join('');
        }
        return lines.join('\n');
    }

    function setup() {
        const m = measure();
        
        // Directional overfill: account for parallax translate (±4% x, ±3% y) + rounding safety
        const OVERFILL_X = +(q.get('overfillx') || 1.80);
        const OVERFILL_Y = +(q.get('overfilly') || 1.70);
        const PAD_COLS = +(q.get('padcols') || 16);
        const PAD_ROWS = +(q.get('padrows') || 16);

        const cols = Math.ceil(Math.max(16, (window.innerWidth  / m.cw) * OVERFILL_X)) + PAD_COLS;
        const rows = Math.ceil(Math.max(16, (window.innerHeight / m.ch) * OVERFILL_Y)) + PAD_ROWS;

        const art1 = generateArt(cols, rows, 0);
        const art2 = generateArt(cols, rows, 100);
        el1.textContent = art1;
        el2.textContent = art2;
    }

    setup();
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(setup, 200);
    }, {passive:true});
  })();
  </script>
</body>
</html>